name: 2025년 최신 CI/CD 파이프라인

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  # 코드 품질 검사
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run Ktlint
      run: ./gradlew ktlintCheck
      
    - name: Run Detekt
      run: ./gradlew detekt
      
    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest
      
    - name: Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Unit Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit

  # 빌드 및 테스트
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/app-release.apk

  # 보안 스캔
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - uses: actions/checkout@v4
    
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'PokeInfo'
        path: '.'
        format: 'HTML'
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: reports/

  # 성능 테스트
  performance-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Run Performance Tests
      run: ./gradlew connectedAndroidTest
      
    - name: Generate Performance Report
      run: |
        echo "Performance test results:" > performance-report.md
        echo "- Build time: $(date)" >> performance-report.md
        echo "- APK size: $(du -h app/build/outputs/apk/debug/app-debug.apk)" >> performance-report.md

  # 배포 (Release 브랜치에서만)
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, performance-test]
    if: github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: release-apk
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          🚀 2025년 최신 기술 스택으로 업데이트된 PokeInfo 앱
          
          ## 주요 변경사항
          - Kotlin 2.1.0 업데이트
          - Compose BOM 2025.01.25 적용
          - 최신 Android Gradle Plugin 사용
          - 성능 및 보안 최적화
        draft: false
        prerelease: false
        files: app-release.apk
