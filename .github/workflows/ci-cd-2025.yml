name: 2025ë…„ ìµœì‹  CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run Ktlint
      run: ./gradlew ktlintCheck
      
    - name: Run Detekt
      run: ./gradlew detekt
      
    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest
      
    - name: Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Unit Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit

  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/app-release.apk

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - uses: actions/checkout@v4
    
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'PokeInfo'
        path: '.'
        format: 'HTML'
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: reports/

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Run Performance Tests
      run: ./gradlew connectedAndroidTest
      
    - name: Generate Performance Report
      run: |
        echo "Performance test results:" > performance-report.md
        echo "- Build time: $(date)" >> performance-report.md
        echo "- APK size: $(du -h app/build/outputs/apk/debug/app-debug.apk)" >> performance-report.md

  # ë°°í¬ (Release ë¸Œëœì¹˜ì—ì„œë§Œ)
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, performance-test]
    if: github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: release-apk
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ğŸš€ 2025ë…„ ìµœì‹  ê¸°ìˆ  ìŠ¤íƒìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ PokeInfo ì•±
          
          ## ì£¼ìš” ë³€ê²½ì‚¬í•­
          - Kotlin 2.1.0 ì—…ë°ì´íŠ¸
          - Compose BOM 2025.01.25 ì ìš©
          - ìµœì‹  Android Gradle Plugin ì‚¬ìš©
          - ì„±ëŠ¥ ë° ë³´ì•ˆ ìµœì í™”
        draft: false
        prerelease: false
        files: app-release.apk
